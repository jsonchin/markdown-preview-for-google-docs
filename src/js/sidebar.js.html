<script>
    const DOC_POLL_TIME = 1 * 1000; // in milliseconds
    
    var intervalId;
    $(function() {
        renderPreviewContents();
        pollAndUpdatePreview();
    });

    const root = $('#gdoc-markdown');
    root.on('click', '*', function (e){
        var html = root.html();
        
        var curNode = $(this);
        var parent = curNode.parent();

        while (!curNode.is(root) && !parent.is(root)) {
            curNode = parent;
            parent = parent.parent();
        }

        var clickedNode = curNode;
        var children = root.children();
        var offset = 0;
        var i;
        var l = [];
        for (i = 0; i < children.length; i+=1) {
            if ($(children[i]).is(clickedNode)) {
                google.script.run.setDocCursor(i);
                break;
            }
            l.push(children[i].innerText.length);
            offset += children[i].innerText.length;
        }
        console.log(l);
        console.log(clickedNode.index());
    });

    function renderPreviewContents() {
        google.script.run
            .withSuccessHandler(setPreviewContents)
            .withFailureHandler(displayError)
            .convertDocToMarkdown();
    }

    function pollAndUpdatePreview() {
        intervalId = setInterval(renderPreviewContents, DOC_POLL_TIME);
    }

    function setPreviewContents(docMarkdownHtml) {
        $('#gdoc-markdown').html(docMarkdownHtml);
    }

    function displayError(error) {
        setPreviewContents('Was not able to render the markdown preview.');
    }
    

</script>
